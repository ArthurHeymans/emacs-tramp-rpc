name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust:
    name: Rust ${{ matrix.name }}
    uses: ./.github/workflows/build.yml
    with:
      target: ${{ matrix.target }}
      os: ${{ matrix.os }}
      test: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - name: Linux aarch64
            os: ubuntu-latest
            target: aarch64-unknown-linux-musl
          - name: macOS x86_64
            os: macos-latest
            target: x86_64-apple-darwin
          - name: macOS aarch64
            os: macos-latest
            target: aarch64-apple-darwin

  format:
    name: Rust Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  elisp:
    name: Emacs Lisp
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs_version: ['30.1']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs_version }}

      - name: Install dependencies
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'msgpack)"

      - name: Byte-compile
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(setq byte-compile-error-on-warn t)" \
            --eval "(push \"$(pwd)/lisp\" load-path)" \
            -f batch-byte-compile lisp/*.el

      - name: Check package metadata
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(with-current-buffer (find-file-noselect \"lisp/tramp-rpc.el\") (package-buffer-info))"

  test-protocol:
    name: Protocol Tests
    runs-on: ubuntu-latest
    needs: elisp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '30.1'

      - name: Install dependencies
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'msgpack)"

      - name: Run protocol tests
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(setq debug-on-error t)" \
            -l test/tramp-rpc-mock-tests.el \
            --eval "(ert-run-tests-batch-and-exit \"^tramp-rpc-mock-test-protocol\")"

  test-server:
    name: Server Integration Tests
    runs-on: ubuntu-latest
    needs: [rust, elisp]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '30.1'

      - name: Download server binary
        uses: actions/download-artifact@v4
        with:
          name: tramp-rpc-server-x86_64-unknown-linux-musl
          path: target/x86_64-unknown-linux-musl/release/

      - name: Make server executable
        run: chmod +x target/x86_64-unknown-linux-musl/release/tramp-rpc-server

      - name: Install dependencies
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'msgpack)"

      - name: Run server integration tests
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(setq debug-on-error t)" \
            -l test/tramp-rpc-mock-tests.el \
            --eval "(ert-run-tests-batch-and-exit '(tag :server))"

  test-full-suite:
    name: Full Test Suite (with SSH)
    runs-on: ubuntu-latest
    needs: [rust, elisp]
    # Only run on main branch to avoid SSH setup complexity in PRs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '30.1'

      - name: Download server binary
        uses: actions/download-artifact@v4
        with:
          name: tramp-rpc-server-x86_64-unknown-linux-musl
          path: target/x86_64-unknown-linux-musl/release/

      - name: Make server executable
        run: chmod +x target/x86_64-unknown-linux-musl/release/tramp-rpc-server

      - name: Setup SSH for localhost
        run: |
          # Generate SSH key
          ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
          # Add to authorized_keys
          cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          # Configure SSH
          echo "Host localhost" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          # Start SSH server if not running
          sudo service ssh start || true
          # Test SSH connection
          ssh localhost "echo 'SSH connection successful'"

      - name: Deploy server to localhost
        run: |
          # Extract version from elisp source (single source of truth)
          VERSION=$(grep -oP 'tramp-rpc-deploy-version "\K[^"]+' lisp/tramp-rpc-deploy.el)
          echo "Deploying version: $VERSION"
          mkdir -p ~/.cache/tramp-rpc
          cp target/x86_64-unknown-linux-musl/release/tramp-rpc-server ~/.cache/tramp-rpc/tramp-rpc-server-${VERSION}

      - name: Install dependencies
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'msgpack)"

      - name: Run full test suite
        env:
          TRAMP_RPC_TEST_HOST: localhost
        run: |
          emacs -Q --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(setq debug-on-error t)" \
            --eval "(setq tramp-verbose 0)" \
            -l test/tramp-rpc-tests.el \
            --eval "(ert-run-tests-batch-and-exit \"^tramp-rpc-test\")"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [rust, elisp, test-protocol, test-server]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Summary ==="
          echo "Rust: ${{ needs.rust.result }}"
          echo "Elisp: ${{ needs.elisp.result }}"
          echo "Protocol Tests: ${{ needs.test-protocol.result }}"
          echo "Server Tests: ${{ needs.test-server.result }}"
          
          if [[ "${{ needs.rust.result }}" != "success" ]] || \
             [[ "${{ needs.elisp.result }}" != "success" ]] || \
             [[ "${{ needs.test-protocol.result }}" != "success" ]] || \
             [[ "${{ needs.test-server.result }}" != "success" ]]; then
            echo "Some tests failed!"
            exit 1
          fi
          echo "All tests passed!"
